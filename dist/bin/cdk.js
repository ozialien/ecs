#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("aws-cdk-lib");
const ecs_service_stack_1 = require("../lib/ecs-service-stack");
/**
 * CDK App Entry Point
 *
 * Uses CDK's native context parameters (-c) for configuration
 *
 * Usage:
 *   # Context parameters only
 *   cdk deploy -c vpcId=vpc-12345678 -c image=nginx:alpine
 *
 *   # With values file (Helm-style)
 *   cdk deploy -c valuesFile=values.yaml
 */
const app = new cdk.App();
// Start with empty config
let config = {};
// 1. Load from values file FIRST if specified
const valuesFile = app.node.tryGetContext('valuesFile');
if (valuesFile) {
    const fs = require('fs');
    const path = require('path');
    if (fs.existsSync(valuesFile)) {
        try {
            const fileContent = fs.readFileSync(valuesFile, 'utf8');
            const ext = path.extname(valuesFile).toLowerCase();
            let values;
            switch (ext) {
                case '.js':
                    values = require(path.resolve(valuesFile));
                    break;
                case '.yaml':
                case '.yml':
                    const yaml = require('js-yaml');
                    values = yaml.load(fileContent);
                    break;
                default:
                    values = JSON.parse(fileContent);
            }
            // Load values file into config
            config = { ...config, ...values };
            console.log(`üìÑ Loaded values from: ${valuesFile}`);
        }
        catch (error) {
            console.warn(`‚ö†Ô∏è  Warning: Failed to parse values file ${valuesFile}: ${error}`);
        }
    }
    else {
        console.warn(`‚ö†Ô∏è  Warning: Values file not found: ${valuesFile}`);
    }
}
// 2. Override with context parameters (highest precedence)
// Only override if the context parameter actually exists
const contextKeys = [
    'vpcId', 'subnetIds', 'clusterName', 'image', 'stackName', 'desiredCount',
    'cpu', 'memory', 'containerPort', 'lbPort', 'healthCheckPath', 'allowedCidr',
    'env', 'secret', 'logGroupName', 'logRetentionDays', 'enableAutoScaling',
    'minCapacity', 'maxCapacity', 'targetCpuUtilization', 'targetMemoryUtilization',
    'taskExecutionRoleArn', 'taskRoleArn', 'taskRolePermissions', 'taskExecutionRolePermissions'
];
contextKeys.forEach(key => {
    const contextValue = app.node.tryGetContext(key);
    if (contextValue !== undefined) {
        // Handle special cases
        if (key === 'subnetIds' && typeof contextValue === 'string') {
            config.subnetIds = contextValue.split(',');
        }
        else if (key === 'env') {
            config.environment = contextValue;
        }
        else if (key === 'secret') {
            config.secrets = contextValue;
        }
        else {
            config[key] = contextValue;
        }
    }
});
// 3. Fall back to environment variables (lowest precedence)
// Apply environment variable fallbacks directly to config
config.vpcId = config.vpcId || process.env.VPC_ID || '';
config.subnetIds = config.subnetIds || process.env.SUBNET_IDS?.split(',') || [];
config.clusterName = config.clusterName || process.env.CLUSTER_NAME || '';
config.image = config.image || process.env.IMAGE || '';
config.stackName = config.stackName || process.env.STACK_NAME || '';
config.desiredCount = config.desiredCount || parseInt(process.env.DESIRED_COUNT || '1');
config.cpu = config.cpu || parseInt(process.env.CPU || '256');
config.memory = config.memory || parseInt(process.env.MEMORY || '512');
config.containerPort = config.containerPort || parseInt(process.env.CONTAINER_PORT || '');
config.lbPort = config.lbPort || parseInt(process.env.LB_PORT || '');
config.healthCheckPath = config.healthCheckPath || process.env.HEALTH_CHECK_PATH || '/';
config.allowedCidr = config.allowedCidr || process.env.ALLOWED_CIDR || '0.0.0.0/0';
config.environment = config.environment || {};
config.secrets = config.secrets || {};
config.logGroupName = config.logGroupName || process.env.LOG_GROUP_NAME;
config.logRetentionDays = config.logRetentionDays || parseInt(process.env.LOG_RETENTION_DAYS || '7');
config.enableAutoScaling = config.enableAutoScaling || process.env.ENABLE_AUTO_SCALING === 'true';
config.minCapacity = config.minCapacity || parseInt(process.env.MIN_CAPACITY || '1');
config.maxCapacity = config.maxCapacity || parseInt(process.env.MAX_CAPACITY || '3');
config.targetCpuUtilization = config.targetCpuUtilization || parseInt(process.env.TARGET_CPU_UTILIZATION || '70');
config.targetMemoryUtilization = config.targetMemoryUtilization || parseInt(process.env.TARGET_MEMORY_UTILIZATION || '70');
config.taskExecutionRoleArn = config.taskExecutionRoleArn || process.env.TASK_EXECUTION_ROLE_ARN;
config.taskRoleArn = config.taskRoleArn || process.env.TASK_ROLE_ARN;
// Validate required parameters
const requiredParams = ['vpcId', 'subnetIds', 'clusterName', 'image', 'stackName', 'containerPort', 'lbPort'];
for (const param of requiredParams) {
    if (!config[param]) {
        console.error(`‚ùå Error: Required parameter '${param}' is missing.`);
        console.error('   Use -c parameter, values file, or set environment variable.');
        console.error('');
        console.error('Examples:');
        console.error('  cdk deploy -c vpcId=vpc-12345678 -c image=nginx:alpine');
        console.error('  cdk deploy -c valuesFile=values.yaml');
        process.exit(1);
    }
}
// Create the ECS service stack using stack name
new ecs_service_stack_1.EcsServiceStack(app, config.stackName, {
    env: {
        account: process.env.CDK_DEFAULT_ACCOUNT,
        region: process.env.CDK_DEFAULT_REGION,
    },
    config: config,
});
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vYmluL2Nkay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxtQ0FBbUM7QUFDbkMsZ0VBQTJEO0FBRzNEOzs7Ozs7Ozs7OztHQVdHO0FBRUgsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7QUFFMUIsMEJBQTBCO0FBQzFCLElBQUksTUFBTSxHQUE4QixFQUFFLENBQUM7QUFFM0MsOENBQThDO0FBQzlDLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3hELElBQUksVUFBVSxFQUFFO0lBQ2QsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUU3QixJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUU7UUFDN0IsSUFBSTtZQUNGLE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3hELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFbkQsSUFBSSxNQUFXLENBQUM7WUFDaEIsUUFBUSxHQUFHLEVBQUU7Z0JBQ1gsS0FBSyxLQUFLO29CQUNSLE1BQU0sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO29CQUMzQyxNQUFNO2dCQUNSLEtBQUssT0FBTyxDQUFDO2dCQUNiLEtBQUssTUFBTTtvQkFDVCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ2hDLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO29C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TyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsQixPQUFPLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzNCLE9BQU8sQ0FBQyxLQUFLLENBQUMsMERBQTBELENBQUMsQ0FBQztRQUMxRSxPQUFPLENBQUMsS0FBSyxDQUFDLHdDQUF3QyxDQUFDLENBQUM7UUFDeEQsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNqQjtDQUNGO0FBRUQsZ0RBQWdEO0FBQ2hELElBQUksbUNBQWUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLFNBQVMsRUFBRTtJQUN6QyxHQUFHLEVBQUU7UUFDSCxPQUFPLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUI7UUFDeEMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCO0tBQ3ZDO0lBQ0QsTUFBTSxFQUFFLE1BQTBCO0NBQ25DLENBQUMsQ0FBQztBQUVILEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcblxuaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IEVjc1NlcnZpY2VTdGFjayB9IGZyb20gJy4uL2xpYi9lY3Mtc2VydmljZS1zdGFjayc7XG5pbXBvcnQgeyBFY3NTZXJ2aWNlQ29uZmlnIH0gZnJvbSAnLi4vbGliL3R5cGVzJztcblxuLyoqXG4gKiBDREsgQXBwIEVudHJ5IFBvaW50XG4gKiBcbiAqIFVzZXMgQ0RLJ3MgbmF0aXZlIGNvbnRleHQgcGFyYW1ldGVycyAoLWMpIGZvciBjb25maWd1cmF0aW9uXG4gKiBcbiAqIFVzYWdlOlxuICogICAjIENvbnRleHQgcGFyYW1ldGVycyBvbmx5XG4gKiAgIGNkayBkZXBsb3kgLWMgdnBjSWQ9dnBjLTEyMzQ1Njc4IC1jIGltYWdlPW5naW54OmFscGluZVxuICogICBcbiAqICAgIyBXaXRoIHZhbHVlcyBmaWxlIChIZWxtLXN0eWxlKVxuICogICBjZGsgZGVwbG95IC1jIHZhbHVlc0ZpbGU9dmFsdWVzLnlhbWxcbiAqL1xuXG5jb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuXG4vLyBTdGFydCB3aXRoIGVtcHR5IGNvbmZpZ1xubGV0IGNvbmZpZzogUGFydGlhbDxFY3NTZXJ2aWNlQ29uZmlnPiA9IHt9O1xuXG4vLyAxLiBMb2FkIGZyb20gdmFsdWVzIGZpbGUgRklSU1QgaWYgc3BlY2lmaWVkXG5jb25zdCB2YWx1ZXNGaWxlID0gYXBwLm5vZGUudHJ5R2V0Q29udGV4dCgndmFsdWVzRmlsZScpO1xuaWYgKHZhbHVlc0ZpbGUpIHtcbiAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuICBjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuICBcbiAgaWYgKGZzLmV4aXN0c1N5bmModmFsdWVzRmlsZSkpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZmlsZUNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmModmFsdWVzRmlsZSwgJ3V0ZjgnKTtcbiAgICAgIGNvbnN0IGV4dCA9IHBhdGguZXh0bmFtZSh2YWx1ZXNGaWxlKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgXG4gICAgICBsZXQgdmFsdWVzOiBhbnk7XG4gICAgICBzd2l0Y2ggKGV4dCkge1xuICAgICAgICBjYXNlICcuanMnOlxuICAgICAgICAgIHZhbHVlcyA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKHZhbHVlc0ZpbGUpKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnLnlhbWwnOlxuICAgICAgICBjYXNlICcueW1sJzpcbiAgICAgICAgICBjb25zdCB5YW1sID0gcmVxdWlyZSgnanMteWFtbCcpO1xuICAgICAgICAgIHZhbHVlcyA9IHlhbWwubG9hZChmaWxlQ29udGVudCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdmFsdWVzID0gSlNPTi5wYXJzZShmaWxlQ29udGVudCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIExvYWQgdmFsdWVzIGZpbGUgaW50byBjb25maWdcbiAgICAgIGNvbmZpZyA9IHsgLi4uY29uZmlnLCAuLi52YWx1ZXMgfTtcbiAgICAgIGNvbnNvbGUubG9nKGDwn5OEIExvYWRlZCB2YWx1ZXMgZnJvbTogJHt2YWx1ZXNGaWxlfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oYOKaoO+4jyAgV2FybmluZzogRmFpbGVkIHRvIHBhcnNlIHZhbHVlcyBmaWxlICR7dmFsdWVzRmlsZX06ICR7ZXJyb3J9YCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUud2Fybihg4pqg77iPICBXYXJuaW5nOiBWYWx1ZXMgZmlsZSBub3QgZm91bmQ6ICR7dmFsdWVzRmlsZX1gKTtcbiAgfVxufVxuXG4vLyAyLiBPdmVycmlkZSB3aXRoIGNvbnRleHQgcGFyYW1ldGVycyAoaGlnaGVzdCBwcmVjZWRlbmNlKVxuLy8gT25seSBvdmVycmlkZSBpZiB0aGUgY29udGV4dCBwYXJhbWV0ZXIgYWN0dWFsbHkgZXhpc3RzXG5jb25zdCBjb250ZXh0S2V5cyA9IFtcbiAgJ3ZwY0lkJywgJ3N1Ym5ldElkcycsICdjbHVzdGVyTmFtZScsICdpbWFnZScsICdzdGFja05hbWUnLCAnZGVzaXJlZENvdW50JywgXG4gICdjcHUnLCAnbWVtb3J5JywgJ2NvbnRhaW5lclBvcnQnLCAnbGJQb3J0JywgJ2hlYWx0aENoZWNrUGF0aCcsICdhbGxvd2VkQ2lkcicsXG4gICdlbnYnLCAnc2VjcmV0JywgJ2xvZ0dyb3VwTmFtZScsICdsb2dSZXRlbnRpb25EYXlzJywgJ2VuYWJsZUF1dG9TY2FsaW5nJyxcbiAgJ21pbkNhcGFjaXR5JywgJ21heENhcGFjaXR5JywgJ3RhcmdldENwdVV0aWxpemF0aW9uJywgJ3RhcmdldE1lbW9yeVV0aWxpemF0aW9uJyxcbiAgJ3Rhc2tFeGVjdXRpb25Sb2xlQXJuJywgJ3Rhc2tSb2xlQXJuJywgJ3Rhc2tSb2xlUGVybWlzc2lvbnMnLCAndGFza0V4ZWN1dGlvblJvbGVQZXJtaXNzaW9ucydcbl07XG5cbmNvbnRleHRLZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgY29uc3QgY29udGV4dFZhbHVlID0gYXBwLm5vZGUudHJ5R2V0Q29udGV4dChrZXkpO1xuICBpZiAoY29udGV4dFZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAvLyBIYW5kbGUgc3BlY2lhbCBjYXNlc1xuICAgIGlmIChrZXkgPT09ICdzdWJuZXRJZHMnICYmIHR5cGVvZiBjb250ZXh0VmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBjb25maWcuc3VibmV0SWRzID0gY29udGV4dFZhbHVlLnNwbGl0KCcsJyk7XG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdlbnYnKSB7XG4gICAgICBjb25maWcuZW52aXJvbm1lbnQgPSBjb250ZXh0VmFsdWU7XG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdzZWNyZXQnKSB7XG4gICAgICBjb25maWcuc2VjcmV0cyA9IGNvbnRleHRWYWx1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uZmlnW2tleSBhcyBrZXlvZiBFY3NTZXJ2aWNlQ29uZmlnXSA9IGNvbnRleHRWYWx1ZTtcbiAgICB9XG4gIH1cbn0pO1xuXG4vLyAzLiBGYWxsIGJhY2sgdG8gZW52aXJvbm1lbnQgdmFyaWFibGVzIChsb3dlc3QgcHJlY2VkZW5jZSlcbi8vIEFwcGx5IGVudmlyb25tZW50IHZhcmlhYmxlIGZhbGxiYWNrcyBkaXJlY3RseSB0byBjb25maWdcbmNvbmZpZy52cGNJZCA9IGNvbmZpZy52cGNJZCB8fCBwcm9jZXNzLmVudi5WUENfSUQgfHwgJyc7XG5jb25maWcuc3VibmV0SWRzID0gY29uZmlnLnN1Ym5ldElkcyB8fCBwcm9jZXNzLmVudi5TVUJORVRfSURTPy5zcGxpdCgnLCcpIHx8IFtdO1xuY29uZmlnLmNsdXN0ZXJOYW1lID0gY29uZmlnLmNsdXN0ZXJOYW1lIHx8IHByb2Nlc3MuZW52LkNMVVNURVJfTkFNRSB8fCAnJztcbmNvbmZpZy5pbWFnZSA9IGNvbmZpZy5pbWFnZSB8fCBwcm9jZXNzLmVudi5JTUFHRSB8fCAnJztcbmNvbmZpZy5zdGFja05hbWUgPSBjb25maWcuc3RhY2tOYW1lIHx8IHByb2Nlc3MuZW52LlNUQUNLX05BTUUgfHwgJyc7XG5jb25maWcuZGVzaXJlZENvdW50ID0gY29uZmlnLmRlc2lyZWRDb3VudCB8fCBwYXJzZUludChwcm9jZXNzLmVudi5ERVNJUkVEX0NPVU5UIHx8ICcxJyk7XG5jb25maWcuY3B1ID0gY29uZmlnLmNwdSB8fCBwYXJzZUludChwcm9jZXNzLmVudi5DUFUgfHwgJzI1NicpO1xuY29uZmlnLm1lbW9yeSA9IGNvbmZpZy5tZW1vcnkgfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuTUVNT1JZIHx8ICc1MTInKTtcbmNvbmZpZy5jb250YWluZXJQb3J0ID0gY29uZmlnLmNvbnRhaW5lclBvcnQgfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuQ09OVEFJTkVSX1BPUlQgfHwgJycpO1xuY29uZmlnLmxiUG9ydCA9IGNvbmZpZy5sYlBvcnQgfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuTEJfUE9SVCB8fCAnJyk7XG5jb25maWcuaGVhbHRoQ2hlY2tQYXRoID0gY29uZmlnLmhlYWx0aENoZWNrUGF0aCB8fCBwcm9jZXNzLmVudi5IRUFMVEhfQ0hFQ0tfUEFUSCB8fCAnLyc7XG5jb25maWcuYWxsb3dlZENpZHIgPSBjb25maWcuYWxsb3dlZENpZHIgfHwgcHJvY2Vzcy5lbnYuQUxMT1dFRF9DSURSIHx8ICcwLjAuMC4wLzAnO1xuY29uZmlnLmVudmlyb25tZW50ID0gY29uZmlnLmVudmlyb25tZW50IHx8IHt9O1xuY29uZmlnLnNlY3JldHMgPSBjb25maWcuc2VjcmV0cyB8fCB7fTtcbmNvbmZpZy5sb2dHcm91cE5hbWUgPSBjb25maWcubG9nR3JvdXBOYW1lIHx8IHByb2Nlc3MuZW52LkxPR19HUk9VUF9OQU1FO1xuY29uZmlnLmxvZ1JldGVudGlvbkRheXMgPSBjb25maWcubG9nUmV0ZW50aW9uRGF5cyB8fCBwYXJzZUludChwcm9jZXNzLmVudi5MT0dfUkVURU5USU9OX0RBWVMgfHwgJzcnKTtcbmNvbmZpZy5lbmFibGVBdXRvU2NhbGluZyA9IGNvbmZpZy5lbmFibGVBdXRvU2NhbGluZyB8fCBwcm9jZXNzLmVudi5FTkFCTEVfQVVUT19TQ0FMSU5HID09PSAndHJ1ZSc7XG5jb25maWcubWluQ2FwYWNpdHkgPSBjb25maWcubWluQ2FwYWNpdHkgfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuTUlOX0NBUEFDSVRZIHx8ICcxJyk7XG5jb25maWcubWF4Q2FwYWNpdHkgPSBjb25maWcubWF4Q2FwYWNpdHkgfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuTUFYX0NBUEFDSVRZIHx8ICczJyk7XG5jb25maWcudGFyZ2V0Q3B1VXRpbGl6YXRpb24gPSBjb25maWcudGFyZ2V0Q3B1VXRpbGl6YXRpb24gfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuVEFSR0VUX0NQVV9VVElMSVpBVElPTiB8fCAnNzAnKTtcbmNvbmZpZy50YXJnZXRNZW1vcnlVdGlsaXphdGlvbiA9IGNvbmZpZy50YXJnZXRNZW1vcnlVdGlsaXphdGlvbiB8fCBwYXJzZUludChwcm9jZXNzLmVudi5UQVJHRVRfTUVNT1JZX1VUSUxJWkFUSU9OIHx8ICc3MCcpO1xuY29uZmlnLnRhc2tFeGVjdXRpb25Sb2xlQXJuID0gY29uZmlnLnRhc2tFeGVjdXRpb25Sb2xlQXJuIHx8IHByb2Nlc3MuZW52LlRBU0tfRVhFQ1VUSU9OX1JPTEVfQVJOO1xuY29uZmlnLnRhc2tSb2xlQXJuID0gY29uZmlnLnRhc2tSb2xlQXJuIHx8IHByb2Nlc3MuZW52LlRBU0tfUk9MRV9BUk47XG5cbi8vIFZhbGlkYXRlIHJlcXVpcmVkIHBhcmFtZXRlcnNcbmNvbnN0IHJlcXVpcmVkUGFyYW1zID0gWyd2cGNJZCcsICdzdWJuZXRJZHMnLCAnY2x1c3Rlck5hbWUnLCAnaW1hZ2UnLCAnc3RhY2tOYW1lJywgJ2NvbnRhaW5lclBvcnQnLCAnbGJQb3J0J107XG5mb3IgKGNvbnN0IHBhcmFtIG9mIHJlcXVpcmVkUGFyYW1zKSB7XG4gIGlmICghY29uZmlnW3BhcmFtIGFzIGtleW9mIEVjc1NlcnZpY2VDb25maWddKSB7XG4gICAgY29uc29sZS5lcnJvcihg4p2MIEVycm9yOiBSZXF1aXJlZCBwYXJhbWV0ZXIgJyR7cGFyYW19JyBpcyBtaXNzaW5nLmApO1xuICAgIGNvbnNvbGUuZXJyb3IoJyAgIFVzZSAtYyBwYXJhbWV0ZXIsIHZhbHVlcyBmaWxlLCBvciBzZXQgZW52aXJvbm1lbnQgdmFyaWFibGUuJyk7XG4gICAgY29uc29sZS5lcnJvcignJyk7XG4gICAgY29uc29sZS5lcnJvcignRXhhbXBsZXM6Jyk7XG4gICAgY29uc29sZS5lcnJvcignICBjZGsgZGVwbG95IC1jIHZwY0lkPXZwYy0xMjM0NTY3OCAtYyBpbWFnZT1uZ2lueDphbHBpbmUnKTtcbiAgICBjb25zb2xlLmVycm9yKCcgIGNkayBkZXBsb3kgLWMgdmFsdWVzRmlsZT12YWx1ZXMueWFtbCcpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgfVxufVxuXG4vLyBDcmVhdGUgdGhlIEVDUyBzZXJ2aWNlIHN0YWNrIHVzaW5nIHN0YWNrIG5hbWVcbm5ldyBFY3NTZXJ2aWNlU3RhY2soYXBwLCBjb25maWcuc3RhY2tOYW1lLCB7XG4gIGVudjoge1xuICAgIGFjY291bnQ6IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQsXG4gICAgcmVnaW9uOiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9SRUdJT04sXG4gIH0sXG4gIGNvbmZpZzogY29uZmlnIGFzIEVjc1NlcnZpY2VDb25maWcsXG59KTtcblxuYXBwLnN5bnRoKCk7ICJdfQ==