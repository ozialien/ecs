#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("aws-cdk-lib");
const ecs_service_stack_1 = require("../lib/ecs-service-stack");
/**
 * CDK App Entry Point
 *
 * Uses CDK's native context parameters (-c) for configuration
 *
 * Usage:
 *   # Context parameters only
 *   cdk deploy -c vpcId=vpc-12345678 -c image=nginx:alpine
 *
 *   # With values file (Helm-style)
 *   cdk deploy -c valuesFile=values.yaml
 */
const app = new cdk.App();
// Start with empty config
let config = {};
// 1. Load from values file FIRST if specified
const valuesFile = app.node.tryGetContext('valuesFile');
if (valuesFile) {
    const fs = require('fs');
    const path = require('path');
    if (fs.existsSync(valuesFile)) {
        try {
            const fileContent = fs.readFileSync(valuesFile, 'utf8');
            const ext = path.extname(valuesFile).toLowerCase();
            let values;
            try {
                switch (ext) {
                    case '.js':
                        values = require(path.resolve(valuesFile));
                        break;
                    case '.yaml':
                    case '.yml':
                        const yaml = require('js-yaml');
                        values = yaml.load(fileContent);
                        break;
                    default:
                        values = JSON.parse(fileContent);
                }
            }
            catch (error) {
                console.error(`‚ùå Error parsing values file ${valuesFile}: ${error}`);
                process.exit(1);
            }
            // Load values file into config
            config = { ...config, ...values };
            console.log(`üìÑ Loaded values from: ${valuesFile}`);
        }
        catch (error) {
            console.warn(`‚ö†Ô∏è  Warning: Failed to parse values file ${valuesFile}: ${error}`);
        }
    }
    else {
        console.warn(`‚ö†Ô∏è  Warning: Values file not found: ${valuesFile}`);
    }
}
// 2. Override with context parameters (highest precedence)
// Only override if the context parameter actually exists
const contextKeys = [
    'vpcId', 'subnetIds', 'clusterName', 'image', 'stackName', 'desiredCount',
    'cpu', 'memory', 'containerPort', 'lbPort', 'healthCheckPath', 'allowedCidr',
    'env', 'secret', 'logGroupName', 'logRetentionDays', 'enableAutoScaling',
    'minCapacity', 'maxCapacity', 'targetCpuUtilization', 'targetMemoryUtilization',
    'taskExecutionRoleArn', 'taskRoleArn', 'taskRolePermissions', 'taskExecutionRolePermissions'
];
contextKeys.forEach(key => {
    const contextValue = app.node.tryGetContext(key);
    if (contextValue !== undefined) {
        // Handle special cases
        if (key === 'subnetIds' && typeof contextValue === 'string') {
            config.subnetIds = contextValue.split(',');
        }
        else if (key === 'env') {
            config.environment = contextValue;
        }
        else if (key === 'secret') {
            config.secrets = contextValue;
        }
        else {
            config[key] = contextValue;
        }
    }
});
// 3. Fall back to environment variables (lowest precedence)
// Apply environment variable fallbacks directly to config
config.vpcId = config.vpcId || process.env.VPC_ID || '';
config.subnetIds = config.subnetIds || process.env.SUBNET_IDS?.split(',') || [];
config.clusterName = config.clusterName || process.env.CLUSTER_NAME || '';
config.image = config.image || process.env.IMAGE || '';
config.stackName = config.stackName || process.env.STACK_NAME || '';
config.desiredCount = config.desiredCount || parseInt(process.env.DESIRED_COUNT || '1');
config.cpu = config.cpu || parseInt(process.env.CPU || '256');
config.memory = config.memory || parseInt(process.env.MEMORY || '512');
config.containerPort = config.containerPort || parseInt(process.env.CONTAINER_PORT || '');
config.lbPort = config.lbPort || parseInt(process.env.LB_PORT || '');
config.healthCheckPath = config.healthCheckPath || process.env.HEALTH_CHECK_PATH || '/';
config.allowedCidr = config.allowedCidr || process.env.ALLOWED_CIDR || '0.0.0.0/0';
config.environment = config.environment || {};
config.secrets = config.secrets || {};
config.logGroupName = config.logGroupName || process.env.LOG_GROUP_NAME;
config.logRetentionDays = config.logRetentionDays || parseInt(process.env.LOG_RETENTION_DAYS || '7');
config.enableAutoScaling = config.enableAutoScaling || process.env.ENABLE_AUTO_SCALING === 'true';
config.minCapacity = config.minCapacity || parseInt(process.env.MIN_CAPACITY || '1');
config.maxCapacity = config.maxCapacity || parseInt(process.env.MAX_CAPACITY || '3');
config.targetCpuUtilization = config.targetCpuUtilization || parseInt(process.env.TARGET_CPU_UTILIZATION || '70');
config.targetMemoryUtilization = config.targetMemoryUtilization || parseInt(process.env.TARGET_MEMORY_UTILIZATION || '70');
config.taskExecutionRoleArn = config.taskExecutionRoleArn || process.env.TASK_EXECUTION_ROLE_ARN;
config.taskRoleArn = config.taskRoleArn || process.env.TASK_ROLE_ARN;
// Validate required parameters
const requiredParams = ['vpcId', 'subnetIds', 'clusterName', 'image', 'stackName', 'containerPort', 'lbPort'];
for (const param of requiredParams) {
    if (!config[param]) {
        console.error(`‚ùå Error: Required parameter '${param}' is missing.`);
        console.error('   Use -c parameter, values file, or set environment variable.');
        console.error('');
        console.error('Examples:');
        console.error('  cdk deploy -c vpcId=vpc-12345678 -c image=nginx:alpine');
        console.error('  cdk deploy -c valuesFile=values.yaml');
        process.exit(1);
    }
}
// Validate parameter formats
if (config.vpcId && !config.vpcId.startsWith('vpc-')) {
    console.error('‚ùå Error: Invalid VPC ID format. Must start with "vpc-"');
    process.exit(1);
}
if (config.subnetIds && Array.isArray(config.subnetIds)) {
    for (const subnetId of config.subnetIds) {
        if (!subnetId.startsWith('subnet-')) {
            console.error(`‚ùå Error: Invalid subnet ID format: ${subnetId}. Must start with "subnet-"`);
            process.exit(1);
        }
    }
}
if (config.containerPort && (config.containerPort < 1 || config.containerPort > 65535)) {
    console.error('‚ùå Error: Invalid container port. Must be between 1 and 65535');
    process.exit(1);
}
if (config.lbPort && (config.lbPort < 1 || config.lbPort > 65535)) {
    console.error('‚ùå Error: Invalid load balancer port. Must be between 1 and 65535');
    process.exit(1);
}
// Create the ECS service stack using stack name
new ecs_service_stack_1.EcsServiceStack(app, config.stackName, {
    env: {
        account: process.env.CDK_DEFAULT_ACCOUNT,
        region: process.env.CDK_DEFAULT_REGION,
    },
    config: config,
});
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vYmluL2Nkay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxtQ0FBbUM7QUFDbkMsZ0VBQTJEO0FBRzNEOzs7Ozs7Ozs7OztHQVdHO0FBRUgsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7QUFFMUIsMEJBQTBCO0FBQzFCLElBQUksTUFBTSxHQUE4QixFQUFFLENBQUM7QUFFM0MsOENBQThDO0FBQzlDLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3hELElBQUksVUFBVSxFQUFFO0lBQ2QsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUU3QixJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUU7UUFDN0IsSUFBSTtZQUNGLE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3hELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFbkQsSUFBSSxNQUFXLENBQUM7WUFDaEIsSUFBSTtnQkFDRixRQUFRLEdBQUcsRUFBRTtvQkFDWCxLQUFLLEtBQUs7d0JBQ1IsTUFBTSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7d0JBQzNDLE1BQU07b0JBQ1IsS0FBSyxPQUFPLENBQUM7b0JBQ2IsS0FBSyxNQUFNO3dCQUNULE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQzt3QkFDaEMsTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxD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LGFBQWEsR0FBRyxLQUFLLENBQUMsRUFBRTtJQUN0RixPQUFPLENBQUMsS0FBSyxDQUFDLDhEQUE4RCxDQUFDLENBQUM7SUFDOUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztDQUNqQjtBQUVELElBQUksTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLEVBQUU7SUFDakUsT0FBTyxDQUFDLEtBQUssQ0FBQyxrRUFBa0UsQ0FBQyxDQUFDO0lBQ2xGLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Q0FDakI7QUFFRCxnREFBZ0Q7QUFDaEQsSUFBSSxtQ0FBZSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsU0FBUyxFQUFFO0lBQ3pDLEdBQUcsRUFBRTtRQUNILE9BQU8sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQjtRQUN4QyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0I7S0FDdkM7SUFDRCxNQUFNLEVBQUUsTUFBMEI7Q0FDbkMsQ0FBQyxDQUFDO0FBRUgsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgRWNzU2VydmljZVN0YWNrIH0gZnJvbSAnLi4vbGliL2Vjcy1zZXJ2aWNlLXN0YWNrJztcbmltcG9ydCB7IEVjc1NlcnZpY2VDb25maWcgfSBmcm9tICcuLi9saWIvdHlwZXMnO1xuXG4vKipcbiAqIENESyBBcHAgRW50cnkgUG9pbnRcbiAqIFxuICogVXNlcyBDREsncyBuYXRpdmUgY29udGV4dCBwYXJhbWV0ZXJzICgtYykgZm9yIGNvbmZpZ3VyYXRpb25cbiAqIFxuICogVXNhZ2U6XG4gKiAgICMgQ29udGV4dCBwYXJhbWV0ZXJzIG9ubHlcbiAqICAgY2RrIGRlcGxveSAtYyB2cGNJZD12cGMtMTIzNDU2NzggLWMgaW1hZ2U9bmdpbng6YWxwaW5lXG4gKiAgIFxuICogICAjIFdpdGggdmFsdWVzIGZpbGUgKEhlbG0tc3R5bGUpXG4gKiAgIGNkayBkZXBsb3kgLWMgdmFsdWVzRmlsZT12YWx1ZXMueWFtbFxuICovXG5cbmNvbnN0IGFwcCA9IG5ldyBjZGsuQXBwKCk7XG5cbi8vIFN0YXJ0IHdpdGggZW1wdHkgY29uZmlnXG5sZXQgY29uZmlnOiBQYXJ0aWFsPEVjc1NlcnZpY2VDb25maWc+ID0ge307XG5cbi8vIDEuIExvYWQgZnJvbSB2YWx1ZXMgZmlsZSBGSVJTVCBpZiBzcGVjaWZpZWRcbmNvbnN0IHZhbHVlc0ZpbGUgPSBhcHAubm9kZS50cnlHZXRDb250ZXh0KCd2YWx1ZXNGaWxlJyk7XG5pZiAodmFsdWVzRmlsZSkge1xuICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG4gIGNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG4gIFxuICBpZiAoZnMuZXhpc3RzU3luYyh2YWx1ZXNGaWxlKSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaWxlQ29udGVudCA9IGZzLnJlYWRGaWxlU3luYyh2YWx1ZXNGaWxlLCAndXRmOCcpO1xuICAgICAgY29uc3QgZXh0ID0gcGF0aC5leHRuYW1lKHZhbHVlc0ZpbGUpLnRvTG93ZXJDYXNlKCk7XG4gICAgICBcbiAgICAgIGxldCB2YWx1ZXM6IGFueTtcbiAgICAgIHRyeSB7XG4gICAgICAgIHN3aXRjaCAoZXh0KSB7XG4gICAgICAgICAgY2FzZSAnLmpzJzpcbiAgICAgICAgICAgIHZhbHVlcyA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKHZhbHVlc0ZpbGUpKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJy55YW1sJzpcbiAgICAgICAgICBjYXNlICcueW1sJzpcbiAgICAgICAgICAgIGNvbnN0IHlhbWwgPSByZXF1aXJlKCdqcy15YW1sJyk7XG4gICAgICAgICAgICB2YWx1ZXMgPSB5YW1sLmxvYWQoZmlsZUNvbnRlbnQpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHZhbHVlcyA9IEpTT04ucGFyc2UoZmlsZUNvbnRlbnQpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGDinYwgRXJyb3IgcGFyc2luZyB2YWx1ZXMgZmlsZSAke3ZhbHVlc0ZpbGV9OiAke2Vycm9yfWApO1xuICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIExvYWQgdmFsdWVzIGZpbGUgaW50byBjb25maWdcbiAgICAgIGNvbmZpZyA9IHsgLi4uY29uZmlnLCAuLi52YWx1ZXMgfTtcbiAgICAgIGNvbnNvbGUubG9nKGDwn5OEIExvYWRlZCB2YWx1ZXMgZnJvbTogJHt2YWx1ZXNGaWxlfWApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oYOKaoO+4jyAgV2FybmluZzogRmFpbGVkIHRvIHBhcnNlIHZhbHVlcyBmaWxlICR7dmFsdWVzRmlsZX06ICR7ZXJyb3J9YCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUud2Fybihg4pqg77iPICBXYXJuaW5nOiBWYWx1ZXMgZmlsZSBub3QgZm91bmQ6ICR7dmFsdWVzRmlsZX1gKTtcbiAgfVxufVxuXG4vLyAyLiBPdmVycmlkZSB3aXRoIGNvbnRleHQgcGFyYW1ldGVycyAoaGlnaGVzdCBwcmVjZWRlbmNlKVxuLy8gT25seSBvdmVycmlkZSBpZiB0aGUgY29udGV4dCBwYXJhbWV0ZXIgYWN0dWFsbHkgZXhpc3RzXG5jb25zdCBjb250ZXh0S2V5cyA9IFtcbiAgJ3ZwY0lkJywgJ3N1Ym5ldElkcycsICdjbHVzdGVyTmFtZScsICdpbWFnZScsICdzdGFja05hbWUnLCAnZGVzaXJlZENvdW50JywgXG4gICdjcHUnLCAnbWVtb3J5JywgJ2NvbnRhaW5lclBvcnQnLCAnbGJQb3J0JywgJ2hlYWx0aENoZWNrUGF0aCcsICdhbGxvd2VkQ2lkcicsXG4gICdlbnYnLCAnc2VjcmV0JywgJ2xvZ0dyb3VwTmFtZScsICdsb2dSZXRlbnRpb25EYXlzJywgJ2VuYWJsZUF1dG9TY2FsaW5nJyxcbiAgJ21pbkNhcGFjaXR5JywgJ21heENhcGFjaXR5JywgJ3RhcmdldENwdVV0aWxpemF0aW9uJywgJ3RhcmdldE1lbW9yeVV0aWxpemF0aW9uJyxcbiAgJ3Rhc2tFeGVjdXRpb25Sb2xlQXJuJywgJ3Rhc2tSb2xlQXJuJywgJ3Rhc2tSb2xlUGVybWlzc2lvbnMnLCAndGFza0V4ZWN1dGlvblJvbGVQZXJtaXNzaW9ucydcbl07XG5cbmNvbnRleHRLZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgY29uc3QgY29udGV4dFZhbHVlID0gYXBwLm5vZGUudHJ5R2V0Q29udGV4dChrZXkpO1xuICBpZiAoY29udGV4dFZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAvLyBIYW5kbGUgc3BlY2lhbCBjYXNlc1xuICAgIGlmIChrZXkgPT09ICdzdWJuZXRJZHMnICYmIHR5cGVvZiBjb250ZXh0VmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBjb25maWcuc3VibmV0SWRzID0gY29udGV4dFZhbHVlLnNwbGl0KCcsJyk7XG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdlbnYnKSB7XG4gICAgICBjb25maWcuZW52aXJvbm1lbnQgPSBjb250ZXh0VmFsdWU7XG4gICAgfSBlbHNlIGlmIChrZXkgPT09ICdzZWNyZXQnKSB7XG4gICAgICBjb25maWcuc2VjcmV0cyA9IGNvbnRleHRWYWx1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uZmlnW2tleSBhcyBrZXlvZiBFY3NTZXJ2aWNlQ29uZmlnXSA9IGNvbnRleHRWYWx1ZTtcbiAgICB9XG4gIH1cbn0pO1xuXG4vLyAzLiBGYWxsIGJhY2sgdG8gZW52aXJvbm1lbnQgdmFyaWFibGVzIChsb3dlc3QgcHJlY2VkZW5jZSlcbi8vIEFwcGx5IGVudmlyb25tZW50IHZhcmlhYmxlIGZhbGxiYWNrcyBkaXJlY3RseSB0byBjb25maWdcbmNvbmZpZy52cGNJZCA9IGNvbmZpZy52cGNJZCB8fCBwcm9jZXNzLmVudi5WUENfSUQgfHwgJyc7XG5jb25maWcuc3VibmV0SWRzID0gY29uZmlnLnN1Ym5ldElkcyB8fCBwcm9jZXNzLmVudi5TVUJORVRfSURTPy5zcGxpdCgnLCcpIHx8IFtdO1xuY29uZmlnLmNsdXN0ZXJOYW1lID0gY29uZmlnLmNsdXN0ZXJOYW1lIHx8IHByb2Nlc3MuZW52LkNMVVNURVJfTkFNRSB8fCAnJztcbmNvbmZpZy5pbWFnZSA9IGNvbmZpZy5pbWFnZSB8fCBwcm9jZXNzLmVudi5JTUFHRSB8fCAnJztcbmNvbmZpZy5zdGFja05hbWUgPSBjb25maWcuc3RhY2tOYW1lIHx8IHByb2Nlc3MuZW52LlNUQUNLX05BTUUgfHwgJyc7XG5jb25maWcuZGVzaXJlZENvdW50ID0gY29uZmlnLmRlc2lyZWRDb3VudCB8fCBwYXJzZUludChwcm9jZXNzLmVudi5ERVNJUkVEX0NPVU5UIHx8ICcxJyk7XG5jb25maWcuY3B1ID0gY29uZmlnLmNwdSB8fCBwYXJzZUludChwcm9jZXNzLmVudi5DUFUgfHwgJzI1NicpO1xuY29uZmlnLm1lbW9yeSA9IGNvbmZpZy5tZW1vcnkgfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuTUVNT1JZIHx8ICc1MTInKTtcbmNvbmZpZy5jb250YWluZXJQb3J0ID0gY29uZmlnLmNvbnRhaW5lclBvcnQgfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuQ09OVEFJTkVSX1BPUlQgfHwgJycpO1xuY29uZmlnLmxiUG9ydCA9IGNvbmZpZy5sYlBvcnQgfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuTEJfUE9SVCB8fCAnJyk7XG5jb25maWcuaGVhbHRoQ2hlY2tQYXRoID0gY29uZmlnLmhlYWx0aENoZWNrUGF0aCB8fCBwcm9jZXNzLmVudi5IRUFMVEhfQ0hFQ0tfUEFUSCB8fCAnLyc7XG5jb25maWcuYWxsb3dlZENpZHIgPSBjb25maWcuYWxsb3dlZENpZHIgfHwgcHJvY2Vzcy5lbnYuQUxMT1dFRF9DSURSIHx8ICcwLjAuMC4wLzAnO1xuY29uZmlnLmVudmlyb25tZW50ID0gY29uZmlnLmVudmlyb25tZW50IHx8IHt9O1xuY29uZmlnLnNlY3JldHMgPSBjb25maWcuc2VjcmV0cyB8fCB7fTtcbmNvbmZpZy5sb2dHcm91cE5hbWUgPSBjb25maWcubG9nR3JvdXBOYW1lIHx8IHByb2Nlc3MuZW52LkxPR19HUk9VUF9OQU1FO1xuY29uZmlnLmxvZ1JldGVudGlvbkRheXMgPSBjb25maWcubG9nUmV0ZW50aW9uRGF5cyB8fCBwYXJzZUludChwcm9jZXNzLmVudi5MT0dfUkVURU5USU9OX0RBWVMgfHwgJzcnKTtcbmNvbmZpZy5lbmFibGVBdXRvU2NhbGluZyA9IGNvbmZpZy5lbmFibGVBdXRvU2NhbGluZyB8fCBwcm9jZXNzLmVudi5FTkFCTEVfQVVUT19TQ0FMSU5HID09PSAndHJ1ZSc7XG5jb25maWcubWluQ2FwYWNpdHkgPSBjb25maWcubWluQ2FwYWNpdHkgfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuTUlOX0NBUEFDSVRZIHx8ICcxJyk7XG5jb25maWcubWF4Q2FwYWNpdHkgPSBjb25maWcubWF4Q2FwYWNpdHkgfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuTUFYX0NBUEFDSVRZIHx8ICczJyk7XG5jb25maWcudGFyZ2V0Q3B1VXRpbGl6YXRpb24gPSBjb25maWcudGFyZ2V0Q3B1VXRpbGl6YXRpb24gfHwgcGFyc2VJbnQocHJvY2Vzcy5lbnYuVEFSR0VUX0NQVV9VVElMSVpBVElPTiB8fCAnNzAnKTtcbmNvbmZpZy50YXJnZXRNZW1vcnlVdGlsaXphdGlvbiA9IGNvbmZpZy50YXJnZXRNZW1vcnlVdGlsaXphdGlvbiB8fCBwYXJzZUludChwcm9jZXNzLmVudi5UQVJHRVRfTUVNT1JZX1VUSUxJWkFUSU9OIHx8ICc3MCcpO1xuY29uZmlnLnRhc2tFeGVjdXRpb25Sb2xlQXJuID0gY29uZmlnLnRhc2tFeGVjdXRpb25Sb2xlQXJuIHx8IHByb2Nlc3MuZW52LlRBU0tfRVhFQ1VUSU9OX1JPTEVfQVJOO1xuY29uZmlnLnRhc2tSb2xlQXJuID0gY29uZmlnLnRhc2tSb2xlQXJuIHx8IHByb2Nlc3MuZW52LlRBU0tfUk9MRV9BUk47XG5cbi8vIFZhbGlkYXRlIHJlcXVpcmVkIHBhcmFtZXRlcnNcbmNvbnN0IHJlcXVpcmVkUGFyYW1zID0gWyd2cGNJZCcsICdzdWJuZXRJZHMnLCAnY2x1c3Rlck5hbWUnLCAnaW1hZ2UnLCAnc3RhY2tOYW1lJywgJ2NvbnRhaW5lclBvcnQnLCAnbGJQb3J0J107XG5mb3IgKGNvbnN0IHBhcmFtIG9mIHJlcXVpcmVkUGFyYW1zKSB7XG4gIGlmICghY29uZmlnW3BhcmFtIGFzIGtleW9mIEVjc1NlcnZpY2VDb25maWddKSB7XG4gICAgY29uc29sZS5lcnJvcihg4p2MIEVycm9yOiBSZXF1aXJlZCBwYXJhbWV0ZXIgJyR7cGFyYW19JyBpcyBtaXNzaW5nLmApO1xuICAgIGNvbnNvbGUuZXJyb3IoJyAgIFVzZSAtYyBwYXJhbWV0ZXIsIHZhbHVlcyBmaWxlLCBvciBzZXQgZW52aXJvbm1lbnQgdmFyaWFibGUuJyk7XG4gICAgY29uc29sZS5lcnJvcignJyk7XG4gICAgY29uc29sZS5lcnJvcignRXhhbXBsZXM6Jyk7XG4gICAgY29uc29sZS5lcnJvcignICBjZGsgZGVwbG95IC1jIHZwY0lkPXZwYy0xMjM0NTY3OCAtYyBpbWFnZT1uZ2lueDphbHBpbmUnKTtcbiAgICBjb25zb2xlLmVycm9yKCcgIGNkayBkZXBsb3kgLWMgdmFsdWVzRmlsZT12YWx1ZXMueWFtbCcpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgfVxufVxuXG4vLyBWYWxpZGF0ZSBwYXJhbWV0ZXIgZm9ybWF0c1xuaWYgKGNvbmZpZy52cGNJZCAmJiAhY29uZmlnLnZwY0lkLnN0YXJ0c1dpdGgoJ3ZwYy0nKSkge1xuICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3I6IEludmFsaWQgVlBDIElEIGZvcm1hdC4gTXVzdCBzdGFydCB3aXRoIFwidnBjLVwiJyk7XG4gIHByb2Nlc3MuZXhpdCgxKTtcbn1cblxuaWYgKGNvbmZpZy5zdWJuZXRJZHMgJiYgQXJyYXkuaXNBcnJheShjb25maWcuc3VibmV0SWRzKSkge1xuICBmb3IgKGNvbnN0IHN1Ym5ldElkIG9mIGNvbmZpZy5zdWJuZXRJZHMpIHtcbiAgICBpZiAoIXN1Ym5ldElkLnN0YXJ0c1dpdGgoJ3N1Ym5ldC0nKSkge1xuICAgICAgY29uc29sZS5lcnJvcihg4p2MIEVycm9yOiBJbnZhbGlkIHN1Ym5ldCBJRCBmb3JtYXQ6ICR7c3VibmV0SWR9LiBNdXN0IHN0YXJ0IHdpdGggXCJzdWJuZXQtXCJgKTtcbiAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICB9XG4gIH1cbn1cblxuaWYgKGNvbmZpZy5jb250YWluZXJQb3J0ICYmIChjb25maWcuY29udGFpbmVyUG9ydCA8IDEgfHwgY29uZmlnLmNvbnRhaW5lclBvcnQgPiA2NTUzNSkpIHtcbiAgY29uc29sZS5lcnJvcign4p2MIEVycm9yOiBJbnZhbGlkIGNvbnRhaW5lciBwb3J0LiBNdXN0IGJlIGJldHdlZW4gMSBhbmQgNjU1MzUnKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufVxuXG5pZiAoY29uZmlnLmxiUG9ydCAmJiAoY29uZmlnLmxiUG9ydCA8IDEgfHwgY29uZmlnLmxiUG9ydCA+IDY1NTM1KSkge1xuICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3I6IEludmFsaWQgbG9hZCBiYWxhbmNlciBwb3J0LiBNdXN0IGJlIGJldHdlZW4gMSBhbmQgNjU1MzUnKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufVxuXG4vLyBDcmVhdGUgdGhlIEVDUyBzZXJ2aWNlIHN0YWNrIHVzaW5nIHN0YWNrIG5hbWVcbm5ldyBFY3NTZXJ2aWNlU3RhY2soYXBwLCBjb25maWcuc3RhY2tOYW1lLCB7XG4gIGVudjoge1xuICAgIGFjY291bnQ6IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQsXG4gICAgcmVnaW9uOiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9SRUdJT04sXG4gIH0sXG4gIGNvbmZpZzogY29uZmlnIGFzIEVjc1NlcnZpY2VDb25maWcsXG59KTtcblxuYXBwLnN5bnRoKCk7ICJdfQ==