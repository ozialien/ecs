#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("aws-cdk-lib");
const ecs_service_stack_1 = require("../lib/ecs-service-stack");
/**
 * CDK App Entry Point
 *
 * Uses CDK's native context parameters (-c) for configuration
 *
 * Usage:
 *   # Context parameters only
 *   cdk deploy -c vpcId=vpc-12345678 -c image=nginx:alpine
 *
 *   # With values file (Helm-style)
 *   cdk deploy -c valuesFile=values.yaml
 */
const app = new cdk.App();
// Start with empty config
let config = {};
// 1. Load from values file FIRST if specified
const valuesFile = app.node.tryGetContext('valuesFile');
if (valuesFile) {
    const fs = require('fs');
    const path = require('path');
    if (fs.existsSync(valuesFile)) {
        try {
            const fileContent = fs.readFileSync(valuesFile, 'utf8');
            const ext = path.extname(valuesFile).toLowerCase();
            let values;
            switch (ext) {
                case '.js':
                    values = require(path.resolve(valuesFile));
                    break;
                case '.yaml':
                case '.yml':
                    const yaml = require('js-yaml');
                    values = yaml.load(fileContent);
                    break;
                default:
                    values = JSON.parse(fileContent);
            }
            // Load values file into config
            config = { ...config, ...values };
            console.log(`üìÑ Loaded values from: ${valuesFile}`);
        }
        catch (error) {
            console.warn(`‚ö†Ô∏è  Warning: Failed to parse values file ${valuesFile}: ${error}`);
        }
    }
    else {
        console.warn(`‚ö†Ô∏è  Warning: Values file not found: ${valuesFile}`);
    }
}
// 2. Override with context parameters (highest precedence)
const contextOverrides = {
    vpcId: app.node.tryGetContext('vpcId'),
    subnetIds: app.node.tryGetContext('subnetIds')?.split(','),
    clusterName: app.node.tryGetContext('clusterName'),
    image: app.node.tryGetContext('image'),
    stackName: app.node.tryGetContext('stackName'),
    desiredCount: app.node.tryGetContext('desiredCount'),
    cpu: app.node.tryGetContext('cpu'),
    memory: app.node.tryGetContext('memory'),
    containerPort: app.node.tryGetContext('containerPort'),
    lbPort: app.node.tryGetContext('lbPort'),
    healthCheckPath: app.node.tryGetContext('healthCheckPath'),
    allowedCidr: app.node.tryGetContext('allowedCidr'),
    environment: app.node.tryGetContext('env'),
    secrets: app.node.tryGetContext('secret'),
    logGroupName: app.node.tryGetContext('logGroupName'),
    logRetentionDays: app.node.tryGetContext('logRetentionDays'),
    enableAutoScaling: app.node.tryGetContext('enableAutoScaling'),
    minCapacity: app.node.tryGetContext('minCapacity'),
    maxCapacity: app.node.tryGetContext('maxCapacity'),
    targetCpuUtilization: app.node.tryGetContext('targetCpuUtilization'),
    targetMemoryUtilization: app.node.tryGetContext('targetMemoryUtilization'),
    taskExecutionRoleArn: app.node.tryGetContext('taskExecutionRoleArn'),
    taskRoleArn: app.node.tryGetContext('taskRoleArn'),
    taskRolePermissions: app.node.tryGetContext('taskRolePermissions'),
    taskExecutionRolePermissions: app.node.tryGetContext('taskExecutionRolePermissions'),
};
// Apply context overrides (only if they exist)
Object.entries(contextOverrides).forEach(([key, value]) => {
    if (value !== undefined) {
        config[key] = value;
    }
});
// 3. Fall back to environment variables (lowest precedence)
const finalConfig = {
    vpcId: config.vpcId || process.env.VPC_ID || '',
    subnetIds: config.subnetIds || process.env.SUBNET_IDS?.split(',') || [],
    clusterName: config.clusterName || process.env.CLUSTER_NAME || '',
    image: config.image || process.env.IMAGE || '',
    stackName: config.stackName || process.env.STACK_NAME || '',
    desiredCount: config.desiredCount || parseInt(process.env.DESIRED_COUNT || '1'),
    cpu: config.cpu || parseInt(process.env.CPU || '256'),
    memory: config.memory || parseInt(process.env.MEMORY || '512'),
    containerPort: config.containerPort || parseInt(process.env.CONTAINER_PORT || ''),
    lbPort: config.lbPort || parseInt(process.env.LB_PORT || ''),
    healthCheckPath: config.healthCheckPath || process.env.HEALTH_CHECK_PATH || '/',
    allowedCidr: config.allowedCidr || process.env.ALLOWED_CIDR || '0.0.0.0/0',
    environment: config.environment || {},
    secrets: config.secrets || {},
    logGroupName: config.logGroupName || process.env.LOG_GROUP_NAME,
    logRetentionDays: config.logRetentionDays || parseInt(process.env.LOG_RETENTION_DAYS || '7'),
    enableAutoScaling: config.enableAutoScaling || process.env.ENABLE_AUTO_SCALING === 'true',
    minCapacity: config.minCapacity || parseInt(process.env.MIN_CAPACITY || '1'),
    maxCapacity: config.maxCapacity || parseInt(process.env.MAX_CAPACITY || '3'),
    targetCpuUtilization: config.targetCpuUtilization || parseInt(process.env.TARGET_CPU_UTILIZATION || '70'),
    targetMemoryUtilization: config.targetMemoryUtilization || parseInt(process.env.TARGET_MEMORY_UTILIZATION || '70'),
    taskExecutionRoleArn: config.taskExecutionRoleArn || process.env.TASK_EXECUTION_ROLE_ARN,
    taskRoleArn: config.taskRoleArn || process.env.TASK_ROLE_ARN,
    taskRolePermissions: config.taskRolePermissions,
    taskExecutionRolePermissions: config.taskExecutionRolePermissions,
};
// Validate required parameters
const requiredParams = ['vpcId', 'subnetIds', 'clusterName', 'image', 'stackName', 'containerPort', 'lbPort'];
for (const param of requiredParams) {
    if (!finalConfig[param]) {
        console.error(`‚ùå Error: Required parameter '${param}' is missing.`);
        console.error('   Use -c parameter, values file, or set environment variable.');
        console.error('');
        console.error('Examples:');
        console.error('  cdk deploy -c vpcId=vpc-12345678 -c image=nginx:alpine');
        console.error('  cdk deploy -c valuesFile=values.yaml');
        process.exit(1);
    }
}
// Create the ECS service stack using stack name
new ecs_service_stack_1.EcsServiceStack(app, finalConfig.stackName, {
    env: {
        account: process.env.CDK_DEFAULT_ACCOUNT,
        region: process.env.CDK_DEFAULT_REGION,
    },
    config: finalConfig,
});
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vYmluL2Nkay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxtQ0FBbUM7QUFDbkMsZ0VBQTJEO0FBRzNEOzs7Ozs7Ozs7OztHQVdHO0FBRUgsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7QUFFMUIsMEJBQTBCO0FBQzFCLElBQUksTUFBTSxHQUE4QixFQUFFLENBQUM7QUFFM0MsOENBQThDO0FBQzlDLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3hELElBQUksVUFBVSxFQUFFO0lBQ2QsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUU3QixJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUU7UUFDN0IsSUFBSTtZQUNGLE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3hELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFbkQsSUFBSSxNQUFXLENBQUM7WUFDaEIsUUFBUSxHQUFHLEVBQUU7Z0JBQ1gsS0FBSyxLQUFLO29CQUNSLE1BQU0sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO29CQUMzQyxNQUFNO2dCQUNSLEtBQUssT0FBTyxDQUFDO2dCQUNiLEtBQUssTUFBTTtvQkFDVCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ2hDLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO29C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RTtJQUM5QyxHQUFHLEVBQUU7UUFDSCxPQUFPLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUI7UUFDeEMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCO0tBQ3ZDO0lBQ0QsTUFBTSxFQUFFLFdBQVc7Q0FDcEIsQ0FBQyxDQUFDO0FBRUgsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgRWNzU2VydmljZVN0YWNrIH0gZnJvbSAnLi4vbGliL2Vjcy1zZXJ2aWNlLXN0YWNrJztcbmltcG9ydCB7IEVjc1NlcnZpY2VDb25maWcgfSBmcm9tICcuLi9saWIvdHlwZXMnO1xuXG4vKipcbiAqIENESyBBcHAgRW50cnkgUG9pbnRcbiAqIFxuICogVXNlcyBDREsncyBuYXRpdmUgY29udGV4dCBwYXJhbWV0ZXJzICgtYykgZm9yIGNvbmZpZ3VyYXRpb25cbiAqIFxuICogVXNhZ2U6XG4gKiAgICMgQ29udGV4dCBwYXJhbWV0ZXJzIG9ubHlcbiAqICAgY2RrIGRlcGxveSAtYyB2cGNJZD12cGMtMTIzNDU2NzggLWMgaW1hZ2U9bmdpbng6YWxwaW5lXG4gKiAgIFxuICogICAjIFdpdGggdmFsdWVzIGZpbGUgKEhlbG0tc3R5bGUpXG4gKiAgIGNkayBkZXBsb3kgLWMgdmFsdWVzRmlsZT12YWx1ZXMueWFtbFxuICovXG5cbmNvbnN0IGFwcCA9IG5ldyBjZGsuQXBwKCk7XG5cbi8vIFN0YXJ0IHdpdGggZW1wdHkgY29uZmlnXG5sZXQgY29uZmlnOiBQYXJ0aWFsPEVjc1NlcnZpY2VDb25maWc+ID0ge307XG5cbi8vIDEuIExvYWQgZnJvbSB2YWx1ZXMgZmlsZSBGSVJTVCBpZiBzcGVjaWZpZWRcbmNvbnN0IHZhbHVlc0ZpbGUgPSBhcHAubm9kZS50cnlHZXRDb250ZXh0KCd2YWx1ZXNGaWxlJyk7XG5pZiAodmFsdWVzRmlsZSkge1xuICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG4gIGNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG4gIFxuICBpZiAoZnMuZXhpc3RzU3luYyh2YWx1ZXNGaWxlKSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaWxlQ29udGVudCA9IGZzLnJlYWRGaWxlU3luYyh2YWx1ZXNGaWxlLCAndXRmOCcpO1xuICAgICAgY29uc3QgZXh0ID0gcGF0aC5leHRuYW1lKHZhbHVlc0ZpbGUpLnRvTG93ZXJDYXNlKCk7XG4gICAgICBcbiAgICAgIGxldCB2YWx1ZXM6IGFueTtcbiAgICAgIHN3aXRjaCAoZXh0KSB7XG4gICAgICAgIGNhc2UgJy5qcyc6XG4gICAgICAgICAgdmFsdWVzID0gcmVxdWlyZShwYXRoLnJlc29sdmUodmFsdWVzRmlsZSkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICcueWFtbCc6XG4gICAgICAgIGNhc2UgJy55bWwnOlxuICAgICAgICAgIGNvbnN0IHlhbWwgPSByZXF1aXJlKCdqcy15YW1sJyk7XG4gICAgICAgICAgdmFsdWVzID0geWFtbC5sb2FkKGZpbGVDb250ZW50KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB2YWx1ZXMgPSBKU09OLnBhcnNlKGZpbGVDb250ZW50KTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gTG9hZCB2YWx1ZXMgZmlsZSBpbnRvIGNvbmZpZ1xuICAgICAgY29uZmlnID0geyAuLi5jb25maWcsIC4uLnZhbHVlcyB9O1xuICAgICAgY29uc29sZS5sb2coYPCfk4QgTG9hZGVkIHZhbHVlcyBmcm9tOiAke3ZhbHVlc0ZpbGV9YCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2Fybihg4pqg77iPICBXYXJuaW5nOiBGYWlsZWQgdG8gcGFyc2UgdmFsdWVzIGZpbGUgJHt2YWx1ZXNGaWxlfTogJHtlcnJvcn1gKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS53YXJuKGDimqDvuI8gIFdhcm5pbmc6IFZhbHVlcyBmaWxlIG5vdCBmb3VuZDogJHt2YWx1ZXNGaWxlfWApO1xuICB9XG59XG5cbi8vIDIuIE92ZXJyaWRlIHdpdGggY29udGV4dCBwYXJhbWV0ZXJzIChoaWdoZXN0IHByZWNlZGVuY2UpXG5jb25zdCBjb250ZXh0T3ZlcnJpZGVzID0ge1xuICB2cGNJZDogYXBwLm5vZGUudHJ5R2V0Q29udGV4dCgndnBjSWQnKSxcbiAgc3VibmV0SWRzOiBhcHAubm9kZS50cnlHZXRDb250ZXh0KCdzdWJuZXRJZHMnKT8uc3BsaXQoJywnKSxcbiAgY2x1c3Rlck5hbWU6IGFwcC5ub2RlLnRyeUdldENvbnRleHQoJ2NsdXN0ZXJOYW1lJyksXG4gIGltYWdlOiBhcHAubm9kZS50cnlHZXRDb250ZXh0KCdpbWFnZScpLFxuICBzdGFja05hbWU6IGFwcC5ub2RlLnRyeUdldENvbnRleHQoJ3N0YWNrTmFtZScpLFxuICBkZXNpcmVkQ291bnQ6IGFwcC5ub2RlLnRyeUdldENvbnRleHQoJ2Rlc2lyZWRDb3VudCcpLFxuICBjcHU6IGFwcC5ub2RlLnRyeUdldENvbnRleHQoJ2NwdScpLFxuICBtZW1vcnk6IGFwcC5ub2RlLnRyeUdldENvbnRleHQoJ21lbW9yeScpLFxuICBjb250YWluZXJQb3J0OiBhcHAubm9kZS50cnlHZXRDb250ZXh0KCdjb250YWluZXJQb3J0JyksXG4gIGxiUG9ydDogYXBwLm5vZGUudHJ5R2V0Q29udGV4dCgnbGJQb3J0JyksXG4gIGhlYWx0aENoZWNrUGF0aDogYXBwLm5vZGUudHJ5R2V0Q29udGV4dCgnaGVhbHRoQ2hlY2tQYXRoJyksXG4gIGFsbG93ZWRDaWRyOiBhcHAubm9kZS50cnlHZXRDb250ZXh0KCdhbGxvd2VkQ2lkcicpLFxuICBlbnZpcm9ubWVudDogYXBwLm5vZGUudHJ5R2V0Q29udGV4dCgnZW52JyksXG4gIHNlY3JldHM6IGFwcC5ub2RlLnRyeUdldENvbnRleHQoJ3NlY3JldCcpLFxuICBsb2dHcm91cE5hbWU6IGFwcC5ub2RlLnRyeUdldENvbnRleHQoJ2xvZ0dyb3VwTmFtZScpLFxuICBsb2dSZXRlbnRpb25EYXlzOiBhcHAubm9kZS50cnlHZXRDb250ZXh0KCdsb2dSZXRlbnRpb25EYXlzJyksXG4gIGVuYWJsZUF1dG9TY2FsaW5nOiBhcHAubm9kZS50cnlHZXRDb250ZXh0KCdlbmFibGVBdXRvU2NhbGluZycpLFxuICBtaW5DYXBhY2l0eTogYXBwLm5vZGUudHJ5R2V0Q29udGV4dCgnbWluQ2FwYWNpdHknKSxcbiAgbWF4Q2FwYWNpdHk6IGFwcC5ub2RlLnRyeUdldENvbnRleHQoJ21heENhcGFjaXR5JyksXG4gIHRhcmdldENwdVV0aWxpemF0aW9uOiBhcHAubm9kZS50cnlHZXRDb250ZXh0KCd0YXJnZXRDcHVVdGlsaXphdGlvbicpLFxuICB0YXJnZXRNZW1vcnlVdGlsaXphdGlvbjogYXBwLm5vZGUudHJ5R2V0Q29udGV4dCgndGFyZ2V0TWVtb3J5VXRpbGl6YXRpb24nKSxcbiAgdGFza0V4ZWN1dGlvblJvbGVBcm46IGFwcC5ub2RlLnRyeUdldENvbnRleHQoJ3Rhc2tFeGVjdXRpb25Sb2xlQXJuJyksXG4gIHRhc2tSb2xlQXJuOiBhcHAubm9kZS50cnlHZXRDb250ZXh0KCd0YXNrUm9sZUFybicpLFxuICB0YXNrUm9sZVBlcm1pc3Npb25zOiBhcHAubm9kZS50cnlHZXRDb250ZXh0KCd0YXNrUm9sZVBlcm1pc3Npb25zJyksXG4gIHRhc2tFeGVjdXRpb25Sb2xlUGVybWlzc2lvbnM6IGFwcC5ub2RlLnRyeUdldENvbnRleHQoJ3Rhc2tFeGVjdXRpb25Sb2xlUGVybWlzc2lvbnMnKSxcbn07XG5cbi8vIEFwcGx5IGNvbnRleHQgb3ZlcnJpZGVzIChvbmx5IGlmIHRoZXkgZXhpc3QpXG5PYmplY3QuZW50cmllcyhjb250ZXh0T3ZlcnJpZGVzKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICBjb25maWdba2V5IGFzIGtleW9mIEVjc1NlcnZpY2VDb25maWddID0gdmFsdWU7XG4gIH1cbn0pO1xuXG4vLyAzLiBGYWxsIGJhY2sgdG8gZW52aXJvbm1lbnQgdmFyaWFibGVzIChsb3dlc3QgcHJlY2VkZW5jZSlcbmNvbnN0IGZpbmFsQ29uZmlnOiBFY3NTZXJ2aWNlQ29uZmlnID0ge1xuICB2cGNJZDogY29uZmlnLnZwY0lkIHx8IHByb2Nlc3MuZW52LlZQQ19JRCB8fCAnJyxcbiAgc3VibmV0SWRzOiBjb25maWcuc3VibmV0SWRzIHx8IHByb2Nlc3MuZW52LlNVQk5FVF9JRFM/LnNwbGl0KCcsJykgfHwgW10sXG4gIGNsdXN0ZXJOYW1lOiBjb25maWcuY2x1c3Rlck5hbWUgfHwgcHJvY2Vzcy5lbnYuQ0xVU1RFUl9OQU1FIHx8ICcnLFxuICBpbWFnZTogY29uZmlnLmltYWdlIHx8IHByb2Nlc3MuZW52LklNQUdFIHx8ICcnLFxuICBzdGFja05hbWU6IGNvbmZpZy5zdGFja05hbWUgfHwgcHJvY2Vzcy5lbnYuU1RBQ0tfTkFNRSB8fCAnJyxcbiAgZGVzaXJlZENvdW50OiBjb25maWcuZGVzaXJlZENvdW50IHx8IHBhcnNlSW50KHByb2Nlc3MuZW52LkRFU0lSRURfQ09VTlQgfHwgJzEnKSxcbiAgY3B1OiBjb25maWcuY3B1IHx8IHBhcnNlSW50KHByb2Nlc3MuZW52LkNQVSB8fCAnMjU2JyksXG4gIG1lbW9yeTogY29uZmlnLm1lbW9yeSB8fCBwYXJzZUludChwcm9jZXNzLmVudi5NRU1PUlkgfHwgJzUxMicpLFxuICBjb250YWluZXJQb3J0OiBjb25maWcuY29udGFpbmVyUG9ydCB8fCBwYXJzZUludChwcm9jZXNzLmVudi5DT05UQUlORVJfUE9SVCB8fCAnJyksXG4gIGxiUG9ydDogY29uZmlnLmxiUG9ydCB8fCBwYXJzZUludChwcm9jZXNzLmVudi5MQl9QT1JUIHx8ICcnKSxcbiAgaGVhbHRoQ2hlY2tQYXRoOiBjb25maWcuaGVhbHRoQ2hlY2tQYXRoIHx8IHByb2Nlc3MuZW52LkhFQUxUSF9DSEVDS19QQVRIIHx8ICcvJyxcbiAgYWxsb3dlZENpZHI6IGNvbmZpZy5hbGxvd2VkQ2lkciB8fCBwcm9jZXNzLmVudi5BTExPV0VEX0NJRFIgfHwgJzAuMC4wLjAvMCcsXG4gIGVudmlyb25tZW50OiBjb25maWcuZW52aXJvbm1lbnQgfHwge30sXG4gIHNlY3JldHM6IGNvbmZpZy5zZWNyZXRzIHx8IHt9LFxuICBsb2dHcm91cE5hbWU6IGNvbmZpZy5sb2dHcm91cE5hbWUgfHwgcHJvY2Vzcy5lbnYuTE9HX0dST1VQX05BTUUsXG4gIGxvZ1JldGVudGlvbkRheXM6IGNvbmZpZy5sb2dSZXRlbnRpb25EYXlzIHx8IHBhcnNlSW50KHByb2Nlc3MuZW52LkxPR19SRVRFTlRJT05fREFZUyB8fCAnNycpLFxuICBlbmFibGVBdXRvU2NhbGluZzogY29uZmlnLmVuYWJsZUF1dG9TY2FsaW5nIHx8IHByb2Nlc3MuZW52LkVOQUJMRV9BVVRPX1NDQUxJTkcgPT09ICd0cnVlJyxcbiAgbWluQ2FwYWNpdHk6IGNvbmZpZy5taW5DYXBhY2l0eSB8fCBwYXJzZUludChwcm9jZXNzLmVudi5NSU5fQ0FQQUNJVFkgfHwgJzEnKSxcbiAgbWF4Q2FwYWNpdHk6IGNvbmZpZy5tYXhDYXBhY2l0eSB8fCBwYXJzZUludChwcm9jZXNzLmVudi5NQVhfQ0FQQUNJVFkgfHwgJzMnKSxcbiAgdGFyZ2V0Q3B1VXRpbGl6YXRpb246IGNvbmZpZy50YXJnZXRDcHVVdGlsaXphdGlvbiB8fCBwYXJzZUludChwcm9jZXNzLmVudi5UQVJHRVRfQ1BVX1VUSUxJWkFUSU9OIHx8ICc3MCcpLFxuICB0YXJnZXRNZW1vcnlVdGlsaXphdGlvbjogY29uZmlnLnRhcmdldE1lbW9yeVV0aWxpemF0aW9uIHx8IHBhcnNlSW50KHByb2Nlc3MuZW52LlRBUkdFVF9NRU1PUllfVVRJTElaQVRJT04gfHwgJzcwJyksXG4gIHRhc2tFeGVjdXRpb25Sb2xlQXJuOiBjb25maWcudGFza0V4ZWN1dGlvblJvbGVBcm4gfHwgcHJvY2Vzcy5lbnYuVEFTS19FWEVDVVRJT05fUk9MRV9BUk4sXG4gIHRhc2tSb2xlQXJuOiBjb25maWcudGFza1JvbGVBcm4gfHwgcHJvY2Vzcy5lbnYuVEFTS19ST0xFX0FSTixcbiAgdGFza1JvbGVQZXJtaXNzaW9uczogY29uZmlnLnRhc2tSb2xlUGVybWlzc2lvbnMsXG4gIHRhc2tFeGVjdXRpb25Sb2xlUGVybWlzc2lvbnM6IGNvbmZpZy50YXNrRXhlY3V0aW9uUm9sZVBlcm1pc3Npb25zLFxufTtcblxuLy8gVmFsaWRhdGUgcmVxdWlyZWQgcGFyYW1ldGVyc1xuY29uc3QgcmVxdWlyZWRQYXJhbXMgPSBbJ3ZwY0lkJywgJ3N1Ym5ldElkcycsICdjbHVzdGVyTmFtZScsICdpbWFnZScsICdzdGFja05hbWUnLCAnY29udGFpbmVyUG9ydCcsICdsYlBvcnQnXTtcbmZvciAoY29uc3QgcGFyYW0gb2YgcmVxdWlyZWRQYXJhbXMpIHtcbiAgaWYgKCFmaW5hbENvbmZpZ1twYXJhbSBhcyBrZXlvZiBFY3NTZXJ2aWNlQ29uZmlnXSkge1xuICAgIGNvbnNvbGUuZXJyb3IoYOKdjCBFcnJvcjogUmVxdWlyZWQgcGFyYW1ldGVyICcke3BhcmFtfScgaXMgbWlzc2luZy5gKTtcbiAgICBjb25zb2xlLmVycm9yKCcgICBVc2UgLWMgcGFyYW1ldGVyLCB2YWx1ZXMgZmlsZSwgb3Igc2V0IGVudmlyb25tZW50IHZhcmlhYmxlLicpO1xuICAgIGNvbnNvbGUuZXJyb3IoJycpO1xuICAgIGNvbnNvbGUuZXJyb3IoJ0V4YW1wbGVzOicpO1xuICAgIGNvbnNvbGUuZXJyb3IoJyAgY2RrIGRlcGxveSAtYyB2cGNJZD12cGMtMTIzNDU2NzggLWMgaW1hZ2U9bmdpbng6YWxwaW5lJyk7XG4gICAgY29uc29sZS5lcnJvcignICBjZGsgZGVwbG95IC1jIHZhbHVlc0ZpbGU9dmFsdWVzLnlhbWwnKTtcbiAgICBwcm9jZXNzLmV4aXQoMSk7XG4gIH1cbn1cblxuLy8gQ3JlYXRlIHRoZSBFQ1Mgc2VydmljZSBzdGFjayB1c2luZyBzdGFjayBuYW1lXG5uZXcgRWNzU2VydmljZVN0YWNrKGFwcCwgZmluYWxDb25maWcuc3RhY2tOYW1lLCB7XG4gIGVudjoge1xuICAgIGFjY291bnQ6IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQsXG4gICAgcmVnaW9uOiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9SRUdJT04sXG4gIH0sXG4gIGNvbmZpZzogZmluYWxDb25maWcsXG59KTtcblxuYXBwLnN5bnRoKCk7ICJdfQ==